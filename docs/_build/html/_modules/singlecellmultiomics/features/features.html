<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>singlecellmultiomics.features.features &#8212; SingleCellMultiOmics 0.0.2 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for singlecellmultiomics.features.features</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">gzip</span><span class="o">,</span> <span class="nn">itertools</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">functools</span>
<div class="viewcode-block" id="FeatureContainer"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer">[docs]</a><span class="k">class</span> <span class="nc">FeatureContainer</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#dict of np.array()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endCoordinates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Flag containing if the features are all coordinate sorted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># When set to true, the class will be (very) verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remapKeys</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#{&#39;chrMT&#39;:&#39;chrM&#39;,&#39;MT&#39;:&#39;chrM&#39;}  Use this to convert chromosome names between the GTF and requested locations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
<div class="viewcode-block" id="FeatureContainer.debugMsg"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.debugMsg">[docs]</a>    <span class="k">def</span> <span class="nf">debugMsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="FeatureContainer.loadGTF"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.loadGTF">[docs]</a>    <span class="k">def</span> <span class="nf">loadGTF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">thirdOnly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">identifierFields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gene_id&#39;</span><span class="p">],</span> <span class="n">ignChr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">select_feature_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exon_select</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load annotations from a GTF file.</span>
<span class="sd">        ignChr: ignore the chr part of the Annotation chromosome</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadedGtfFeatures</span> <span class="o">=</span> <span class="n">thirdOnly</span>
        <span class="c1">#pattern = &#39;^(.*) &quot;(.*).*&quot;&#39;</span>
        <span class="c1">#prog = re.compile(pattern)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line_id</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">head</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">line_id</span><span class="o">&gt;</span><span class="n">head</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;#&#39;</span><span class="p">:</span>
                    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">thirdOnly</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">thirdOnly</span><span class="p">:</span>
                            <span class="k">continue</span>

                    <span class="c1">#Example line: (gene)</span>
                    <span class="c1">#1  havana  gene    11869   14409   .   +   .   gene_id &quot;ENSG00000223972&quot;; gene_version &quot;5&quot;; gene_name &quot;DDX11L1&quot;; gene_source &quot;havana&quot;; gene_biotype &quot;transcribed_unprocessed_pseudogene&quot;; havana_gene &quot;OTTHUMG00000000961&quot;; havana_gene_version &quot;2&quot;;</span>
                    <span class="c1">#Example line (exon)</span>
                    <span class="c1">#1  havana  exon    11869   12227   .   +   .   gene_id &quot;ENSG00000223972&quot;; gene_version &quot;5&quot;; transcript_id &quot;ENST00000456328&quot;; transcript_version &quot;2&quot;; exon_number &quot;1&quot;; gene_name &quot;DDX11L1&quot;; gene_source &quot;havana&quot;; gene_biotype &quot;transcribed_unprocessed_pseudogene&quot;; havana_gene &quot;OTTHUMG00000000961&quot;; havana_gene_version &quot;2&quot;; transcript_name &quot;DDX11L1-002&quot;; transcript_source &quot;havana&quot;; transcript_biotype &quot;processed_transcript&quot;; havana_transcript &quot;OTTHUMT00000362751&quot;; havana_transcript_version &quot;1&quot;; exon_id &quot;ENSE00002234944&quot;; exon_version &quot;1&quot;; tag &quot;basic&quot;; transcript_support_level &quot;1&quot;;</span>
                    <span class="c1">#Part, info</span>
                    <span class="c1">#0  Chromosome</span>
                    <span class="c1">#1  Source</span>
                    <span class="c1">#2  Feature type (matches thirdOnly)</span>
                    <span class="c1">#3 Feature Start</span>
                    <span class="c1">#4 Feature End</span>
                    <span class="c1">#5 .</span>
                    <span class="c1">#6 Strand</span>
                    <span class="c1">#7 .</span>
                    <span class="c1">#8 KEY &quot;VALUE&quot;;</span>
                    <span class="c1">#keyValues = { part.strip().split()[0]:part.strip().split()[1].replace(&#39;&quot;&#39;,&#39;&#39;) for part in parts[-1].split(&#39;;&#39;) }</span>

                    <span class="c1">#keyValues = {i.group(1) : i.group(2) for i in (prog.match(j) for j in parts[-1].split(&#39;; &#39;))}</span>
                    <span class="k">if</span> <span class="n">select_feature_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">select_feature_type</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">exon</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">exon_select</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exon</span> <span class="ow">in</span> <span class="n">exon_select</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">keyValues</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
                        <span class="n">kv</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kv</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                            <span class="n">keyValues</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span>  <span class="n">value</span>


                    <span class="c1">#self.addFeature( self.remapKeys.get(parts[0], parts[0]), int(parts[3]), int(parts[4]), parts[9].replace(&#39;&quot;&#39;,&#39;&#39;).replace(&#39;;&#39;,&#39;&#39;))</span>
                    <span class="n">chrom</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">chrom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remapKeys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">chrom</span><span class="p">)</span>
                    <span class="n">chromosome</span> <span class="o">=</span> <span class="n">chrom</span> <span class="k">if</span> <span class="n">ignChr</span><span class="o">==</span><span class="kc">False</span> <span class="k">else</span>  <span class="n">chrom</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">identifierFields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;exon&#39;</span><span class="p">:</span>
                            <span class="n">featureName</span> <span class="o">=</span> <span class="n">keyValues</span><span class="p">[</span><span class="s1">&#39;exon_id&#39;</span><span class="p">]</span>
                            <span class="c1">#featureName = &#39;,&#39;.join([keyValues[&#39;exon_id&#39;],keyValues[&#39;transcript_id&#39;]])</span>
                        <span class="k">elif</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;gene&#39;</span><span class="p">:</span>
                            <span class="n">featureName</span> <span class="o">=</span> <span class="n">keyValues</span><span class="p">[</span><span class="s1">&#39;gene_id&#39;</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;transcript&#39;</span><span class="p">:</span>
                            <span class="n">featureName</span> <span class="o">=</span> <span class="n">keyValues</span><span class="p">[</span><span class="s1">&#39;transcript_id&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">featureName</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">keyValues</span><span class="p">[</span><span class="s1">&#39;transcript_id&#39;</span><span class="p">]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">featureName</span> <span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="p">[</span><span class="n">keyValues</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">identifierFields</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keyValues</span><span class="p">]</span> <span class="p">)</span>



                    <span class="bp">self</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">remapKeys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chromosome</span><span class="p">,</span> <span class="n">chromosome</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="n">strand</span><span class="o">=</span><span class="n">parts</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">featureName</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>   <span class="p">(</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s1">&#39;type&#39;</span><span class="p">,</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s1">&#39;gene_id&#39;</span><span class="p">,</span><span class="n">keyValues</span><span class="p">[</span><span class="s1">&#39;gene_id&#39;</span><span class="p">])))</span>   <span class="p">)</span> <span class="p">)</span>


            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loaded </span><span class="si">%s</span><span class="s2"> features, now sorting&quot;</span> <span class="o">%</span> <span class="nb">sum</span><span class="p">([</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done sorting&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The following chromosomes are available:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span></div>

<div class="viewcode-block" id="FeatureContainer.annotateUTRs"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.annotateUTRs">[docs]</a>    <span class="k">def</span> <span class="nf">annotateUTRs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">utrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;three_prime_utr&#39;</span><span class="p">,</span><span class="s1">&#39;five_prime_utr&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;flag the exons that contain a utr&quot;&quot;&quot;</span>

        <span class="n">chromosomes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">typeRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;.*type:([^,]*).*&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chromosomes</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;chromosome:</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">typeRegex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">c</span><span class="p">]])</span>
            <span class="n">featStartEndStrand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">c</span><span class="p">]],</span>
                <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">c</span><span class="p">]],[</span><span class="n">f</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">c</span><span class="p">]]])</span>

            <span class="n">fe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">types</span><span class="o">==</span><span class="s1">&#39;exon&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">c</span><span class="p">]])[</span><span class="n">fe</span><span class="p">]</span>
            <span class="n">starts</span> <span class="o">=</span> <span class="n">featStartEndStrand</span><span class="p">[</span><span class="mi">0</span><span class="p">,:][</span><span class="n">fe</span><span class="p">]</span>


            <span class="k">for</span> <span class="n">utr</span> <span class="ow">in</span> <span class="n">utrs</span><span class="p">:</span>
                <span class="n">isUtrF</span> <span class="o">=</span> <span class="s1">&#39;is_&#39;</span><span class="o">+</span><span class="n">utr</span><span class="o">+</span><span class="s1">&#39;:False&#39;</span>
                <span class="n">isUtrT</span> <span class="o">=</span> <span class="s1">&#39;is_&#39;</span><span class="o">+</span><span class="n">utr</span><span class="o">+</span><span class="s1">&#39;:True&#39;</span>
                <span class="n">utrRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">isUtrF</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">fe</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">hitStart</span><span class="p">,</span> <span class="n">hitEnd</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">hitStrand</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">position</span><span class="p">]</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">data</span><span class="p">,</span><span class="n">isUtrF</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">position</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hitStart</span><span class="p">,</span> <span class="n">hitEnd</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">hitStrand</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="n">lu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">types</span><span class="o">==</span><span class="n">utr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">lu</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="n">foo</span><span class="p">,</span><span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">featStartEndStrand</span><span class="p">[:,</span><span class="n">lu</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">lu</span><span class="o">=</span><span class="n">lu</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lu</span><span class="p">:</span>
                        <span class="n">hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findFeaturesBetween</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                        <span class="n">hitNames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">])</span>
                        <span class="n">hitStarts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hitNames</span><span class="p">):</span>
                            <span class="n">fl</span> <span class="o">=</span> <span class="n">starts</span><span class="o">==</span><span class="n">hitStarts</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                            <span class="n">fn</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">fl</span><span class="p">]</span><span class="o">==</span><span class="n">n</span>
                            <span class="n">positions</span><span class="o">=</span><span class="n">fe</span><span class="p">[</span><span class="n">fl</span><span class="p">][</span><span class="n">fn</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                                <span class="p">(</span><span class="n">hitStart</span><span class="p">,</span> <span class="n">hitEnd</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">hitStrand</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">position</span><span class="p">]</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">utrRegex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">isUtrT</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">position</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hitStart</span><span class="p">,</span> <span class="n">hitEnd</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">hitStrand</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

                        <span class="c1">#hitTypes = np.array([typeRegex.match(h[-1]).group(1) for h in hits])#np.array([h[-1][&#39;type&#39;] for h in hits])</span>
                        <span class="c1">#hitNames = np.array([h[2] for h in hits])</span>
                        <span class="c1">#fh = hitTypes==&#39;exon&#39;</span>

                        <span class="c1">#if np.any(fh):</span>
                        <span class="c1">#   hitNames=np.unique(hitNames[fh])</span>
                        <span class="c1">#   for n in hitNames:</span>
                        <span class="c1">#       fn = names==n</span>
                        <span class="c1">#       positions = fe[fn]</span>
                        <span class="c1">#       for position in positions:</span>
                        <span class="c1">#           (hitStart, hitEnd, name, hitStrand, data) = self.features[c][position]</span>
                        <span class="c1">#           data = utrRegex.sub(isUtrT,data)</span>
                        <span class="c1">#           self.features[c][position] = (hitStart, hitEnd, name, hitStrand, data)</span>



<div class="viewcode-block" id="FeatureContainer.loadBED"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.loadBED">[docs]</a>    <span class="k">def</span> <span class="nf">loadBED</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">ignChr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parseBlocks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load UCSC based table. &quot;&quot;&quot;</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        parseBlocks ; parse the defined blocks as separate features</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="p">(</span><span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;.gz&#39;</span> <span class="ow">in</span> <span class="n">path</span> <span class="k">else</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1">#chr1   14662   187832  calJac3:ENSCJAT00000061222.1-1.1    943 -   187832  187832  0   9   5,129,69,110,42,23,133,202,78,  0,38,307,1133,1243,1944,1970,172713,173092,</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;track&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">blockAvail</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">chrom</span><span class="p">,</span> <span class="n">chromStart</span><span class="p">,</span> <span class="n">chromEnd</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">thickStart</span><span class="p">,</span> <span class="n">thickEnd</span><span class="p">,</span> <span class="n">itemRGB</span><span class="p">,</span> <span class="n">blockCount</span><span class="p">,</span> <span class="n">blockSizes</span><span class="p">,</span> <span class="n">blockStarts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">chrom</span><span class="p">,</span> <span class="n">chromStart</span><span class="p">,</span> <span class="n">chromEnd</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">itemRGB</span><span class="p">,</span> <span class="n">blockCount</span><span class="p">,</span> <span class="n">blockSizes</span><span class="p">,</span> <span class="n">blockStarts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">chrom</span><span class="p">,</span> <span class="n">chromStart</span><span class="p">,</span> <span class="n">chromEnd</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">strand</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                            <span class="n">blockAvail</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not parse </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">chrom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remapKeys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">chrom</span><span class="p">)</span>
                <span class="n">chrom</span> <span class="o">=</span> <span class="n">chrom</span> <span class="k">if</span> <span class="n">ignChr</span><span class="o">==</span><span class="kc">False</span> <span class="k">else</span>  <span class="n">chrom</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">blockAvail</span> <span class="ow">and</span> <span class="n">parseBlocks</span><span class="p">:</span>
                    <span class="n">blockStarts</span> <span class="o">=</span> <span class="n">blockStarts</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">blockStarts</span><span class="p">[</span><span class="n">index</span><span class="p">])</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">chromStart</span><span class="p">)</span> <span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">blockSize</span><span class="p">)</span> <span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">blockSize</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">blockSizes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blockSize</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span>  <span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span><span class="o">!=</span><span class="nb">int</span><span class="p">(</span><span class="n">blockCount</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;BlockCount at line </span><span class="si">%s</span><span class="s1"> do not match actual amount of blocks present&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">chromStart</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">chromEnd</span><span class="p">)</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">chromStart</span><span class="p">),)]</span>

                <span class="c1">#Report very big annotations?</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span> <span class="p">(</span><span class="n">e</span><span class="o">-</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">)</span> <span class="p">)</span><span class="o">&gt;</span><span class="mi">10000</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">chromStart</span><span class="p">,</span> <span class="n">chromEnd</span><span class="p">,</span> <span class="n">blocks</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">start</span><span class="o">+</span><span class="n">length</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="n">strand</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loaded </span><span class="si">%s</span><span class="s2"> features, now sorting&quot;</span> <span class="o">%</span> <span class="nb">sum</span><span class="p">([</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done sorting&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FeatureContainer.getReferenceList"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.getReferenceList">[docs]</a>    <span class="k">def</span> <span class="nf">getReferenceList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span></div>

<div class="viewcode-block" id="FeatureContainer.addFeature"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.addFeature">[docs]</a>    <span class="k">def</span> <span class="nf">addFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chromosome</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">strand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">strand</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid strand specified: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">strand</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">start</span><span class="p">,</span> <span class="nb">int</span> <span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">end</span><span class="p">,</span> <span class="nb">int</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Start and end coordinates should be integers&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Adding feature: chromosome:</span><span class="si">%s</span><span class="s2">, start:</span><span class="si">%s</span><span class="s2">, end:</span><span class="si">%s</span><span class="s2">, name:</span><span class="si">%s</span><span class="s2">, strand:</span><span class="si">%s</span><span class="s2">, data:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">chromosome</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">chromosome</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="FeatureContainer.getCentroids"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.getCentroids">[docs]</a>    <span class="k">def</span> <span class="nf">getCentroids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">centroids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">chromosome</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span><span class="p">:</span>
            <span class="n">centroids</span><span class="p">[</span> <span class="n">chromosome</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">strand</span><span class="p">,</span><span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]:</span>
                <span class="n">centroids</span><span class="p">[</span> <span class="n">chromosome</span> <span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">start</span>
        <span class="k">return</span><span class="p">(</span><span class="n">centroids</span><span class="p">)</span></div>


<div class="viewcode-block" id="FeatureContainer.findFeaturesBetween"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.findFeaturesBetween">[docs]</a>    <span class="k">def</span> <span class="nf">findFeaturesBetween</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chromosome</span><span class="p">,</span> <span class="n">sampleStart</span><span class="p">,</span> <span class="n">sampleEnd</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">chromosome</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Chromosome </span><span class="si">%s</span><span class="s2"> is not present in the annotations&quot;</span> <span class="o">%</span> <span class="n">chromosome</span><span class="p">)</span>
            <span class="k">return</span><span class="p">([])</span>
        <span class="n">startIndex</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span><span class="p">[</span><span class="n">chromosome</span><span class="p">],</span> <span class="n">sampleStart</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">startIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">startIndex</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">endCoordinates</span><span class="p">[</span><span class="n">chromosome</span><span class="p">],</span> <span class="n">sampleEnd</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)))</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span><span class="p">(</span><span class="n">x</span> <span class="ow">and</span> <span class="n">startIndex</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">])</span> <span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">startIndex</span><span class="p">]</span>
            <span class="p">(</span><span class="n">hitStart</span><span class="p">,</span> <span class="n">hitEnd</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">hitStrand</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>  <span class="o">=</span> <span class="n">d</span>
            <span class="k">if</span> <span class="n">hitStart</span><span class="o">&gt;</span><span class="n">sampleEnd</span><span class="p">:</span>
                <span class="n">x</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Does the feature overlap the sampling region</span>
                <span class="k">if</span><span class="p">(</span> <span class="nb">max</span><span class="p">(</span><span class="n">sampleStart</span><span class="p">,</span><span class="n">hitStart</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sampleEnd</span><span class="p">,</span><span class="n">hitEnd</span><span class="p">)</span> <span class="p">):</span>
                    <span class="c1">#print(sampleStart,sampleEnd, hitStart,hitEnd, name)</span>
                    <span class="c1"># Check the strand</span>
                    <span class="k">if</span> <span class="n">strand</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">strand</span><span class="o">==</span><span class="n">hitStrand</span><span class="p">):</span>
                        <span class="n">hits</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">startIndex</span><span class="o">+=</span><span class="mi">1</span>

        <span class="n">hits</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="nb">set</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="n">chromosome</span><span class="p">,</span> <span class="n">sampleStart</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="p">))</span>
        <span class="n">hits</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="nb">set</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="n">chromosome</span><span class="p">,</span> <span class="n">sampleEnd</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span> <span class="p">))</span>

        <span class="k">return</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">hits</span><span class="p">))</span></div>

<div class="viewcode-block" id="FeatureContainer.sort"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.sort">[docs]</a>    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build coordinate sorted datastructure to perform fast lookups.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endIndexes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endIndexLookup</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastIndex</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxFeatureSizes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">chromosome</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1">#Sort in place and return new indices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span> <span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endCoordinates</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span> <span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endIndexes</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endCoordinates</span><span class="p">[</span><span class="n">chromosome</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endCoordinates</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endCoordinates</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">endIndexes</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endIndexLookup</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">inR</span><span class="p">:</span><span class="n">orig</span> <span class="k">for</span> <span class="n">orig</span><span class="p">,</span> <span class="n">inR</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endIndexes</span><span class="p">[</span><span class="n">chromosome</span><span class="p">])}</span>


            <span class="c1">####################### perform magic indexing #######################</span>
            <span class="n">maxLengthFeature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxFeatureSizes</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxLengthFeature</span>

            <span class="n">lowestStarts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
                <span class="p">(</span> <span class="nb">min</span><span class="p">(</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span> <span class="n">chromosome</span><span class="p">,</span> <span class="n">feature</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">optim</span><span class="o">=</span><span class="s1">&#39;nb&#39;</span><span class="p">)))</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span> <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">fastIndex</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span><span class="p">[</span><span class="n">chromosome</span><span class="p">],</span><span class="n">lowestStarts</span><span class="p">,</span><span class="s1">&#39;left&#39;</span><span class="p">)</span></div>
            <span class="c1">########################</span>

        <span class="c1"># find the longest feature</span>




    <span class="sd">&quot;&quot;&quot;Return a feature left of the lookupCoordinate&quot;&quot;&quot;</span>
<div class="viewcode-block" id="FeatureContainer.findNearestLeftFeature"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.findNearestLeftFeature">[docs]</a>    <span class="k">def</span> <span class="nf">findNearestLeftFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chromosome</span><span class="p">,</span> <span class="n">lookupCoordinate</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chromosome</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">return</span><span class="p">([])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot; Find closest feature left of the supplied coordinate &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endCoordinates</span><span class="p">[</span><span class="n">chromosome</span><span class="p">],</span> <span class="n">lookupCoordinate</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endCoordinates</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Looking up </span><span class="si">%s</span><span class="s2">, Initial index is </span><span class="si">%s</span><span class="s2"> (start: </span><span class="si">%s</span><span class="s2">, end </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lookupCoordinate</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">index</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;No feature hit&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">index</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;No feature hit&#39;</span> <span class="p">))</span>
        <span class="c1">#index = np.clip(index, 1, len(self.endCoordinates)-1)</span>
        <span class="c1">#Check if the index is zero, and this feature is actually more right:</span>
        <span class="k">if</span> <span class="n">index</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;overflow INDEX condition, decreasing index&quot;</span><span class="p">)</span>
            <span class="n">index</span><span class="o">-=</span><span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">lookupCoordinate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Zero INDEX condition. Rejected feature.&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">([])</span>

        <span class="n">hitStrand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">index</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="c1">#Find first feature which is on the same strand...</span>
        <span class="k">while</span> <span class="n">strand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">hitStrand</span><span class="o">!=</span><span class="n">strand</span><span class="p">)</span> <span class="ow">and</span> <span class="n">index</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">index</span><span class="o">-=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">index</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">hitStrand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">index</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">index</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span><span class="p">([])</span>
        <span class="k">return</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">index</span><span class="p">]])</span></div>
<div class="viewcode-block" id="FeatureContainer.findNearestRightFeature"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.findNearestRightFeature">[docs]</a>    <span class="k">def</span> <span class="nf">findNearestRightFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chromosome</span><span class="p">,</span> <span class="n">lookupCoordinate</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chromosome</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">return</span><span class="p">([])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot; Find closest feature left of the supplied coordinate &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span><span class="p">[</span><span class="n">chromosome</span><span class="p">],</span> <span class="n">lookupCoordinate</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Looking up </span><span class="si">%s</span><span class="s2">, Initial index is </span><span class="si">%s</span><span class="s2"> (start: </span><span class="si">%s</span><span class="s2">, end </span><span class="si">%s</span><span class="s2">), strand </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lookupCoordinate</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">index</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;No feature hit&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">index</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;No feature hit&#39;</span><span class="p">,</span> <span class="n">strand</span> <span class="p">))</span>

        <span class="c1">#Check if the index is maxlen, and this feature is actually more right</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">index</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;No feature on the right&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">([])</span>
            <span class="n">index</span><span class="o">-=</span><span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Index is now </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">lookupCoordinate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Zero INDEX condition. Rejected feature.&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">([])</span>

        <span class="c1">#print(self.features[chromosome][index])</span>
        <span class="n">hitStrand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">index</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="c1">#Find first feature which is on the same strand...</span>
        <span class="k">while</span> <span class="n">strand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">hitStrand</span><span class="o">!=</span><span class="n">strand</span><span class="p">):</span>
            <span class="n">index</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;No feature on the right&quot;</span><span class="p">)</span>
                <span class="k">return</span><span class="p">([])</span>
            <span class="n">hitStrand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">index</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">index</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span><span class="p">([])</span>
        <span class="k">return</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">index</span><span class="p">]])</span></div>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
<div class="viewcode-block" id="FeatureContainer.findNearestFeature"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.findNearestFeature">[docs]</a>    <span class="k">def</span> <span class="nf">findNearestFeature</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">chromosome</span><span class="p">,</span> <span class="n">lookupCoordinate</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="n">chromosome</span><span class="p">,</span> <span class="n">lookupCoordinate</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s1">&#39;Issued nearest feature search, but the coordinate lies within </span><span class="si">%s</span><span class="s1"> feature(s), returning those&#39;</span>  <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">fr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findNearestRightFeature</span><span class="p">(</span> <span class="n">chromosome</span><span class="p">,</span> <span class="n">lookupCoordinate</span><span class="o">=</span><span class="n">lookupCoordinate</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="n">strand</span> <span class="p">)</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findNearestLeftFeature</span><span class="p">(</span> <span class="n">chromosome</span><span class="p">,</span> <span class="n">lookupCoordinate</span><span class="o">=</span><span class="n">lookupCoordinate</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="n">strand</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s1">&#39;Feature R presence </span><span class="si">%s</span><span class="s1">, feature L presence: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fr</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">fl</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fr</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Returning no hits&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">([])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">fr</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Returning Left as right is empty&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Returning Right as left is empty&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">fr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">distanceR</span><span class="p">,</span> <span class="n">distanceL</span> <span class="o">=</span>  <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">lookupCoordinate</span><span class="p">,</span> <span class="n">lookupCoordinate</span> <span class="o">-</span> <span class="n">fl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Distances: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">distanceR</span><span class="p">,</span> <span class="n">distanceL</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">distanceR</span><span class="o">&lt;</span><span class="n">distanceL</span><span class="p">:</span>
                <span class="k">return</span><span class="p">(</span> <span class="p">[</span> <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">distanceL</span><span class="o">&lt;</span><span class="n">distanceR</span><span class="p">:</span>
                <span class="k">return</span><span class="p">(</span> <span class="p">[</span> <span class="n">fl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span><span class="p">(</span> <span class="p">[</span> <span class="n">fl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span></div>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
<div class="viewcode-block" id="FeatureContainer.findFeaturesAt"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.findFeaturesAt">[docs]</a>    <span class="k">def</span> <span class="nf">findFeaturesAt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chromosome</span><span class="p">,</span> <span class="n">lookupCoordinate</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optim</span><span class="o">=</span><span class="s1">&#39;bdbnb&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;Obtain the features at a give coordinate and optionally strand.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">chromosome</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Chromosome </span><span class="si">%s</span><span class="s2"> is not present in the annotations&quot;</span> <span class="o">%</span> <span class="n">chromosome</span><span class="p">)</span>
            <span class="k">return</span><span class="p">([])</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span><span class="p">[</span><span class="n">chromosome</span><span class="p">],</span> <span class="n">lookupCoordinate</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">optim</span><span class="o">==</span><span class="s1">&#39;bdbnb&#39;</span><span class="p">:</span>
            <span class="n">startRange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastIndex</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">endRange</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]))</span> <span class="c1"># We stop looking at the rightmost h</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;index: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastIndex</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Fast index result: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastIndex</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                <span class="n">ml</span> <span class="o">=</span> <span class="n">lookupCoordinate</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxFeatureSizes</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Vanilla index result: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span><span class="p">[</span><span class="n">chromosome</span><span class="p">],</span> <span class="n">ml</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Start looking from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">startRange</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;To </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">endRange</span><span class="p">)</span>

            <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startRange</span><span class="p">,</span><span class="n">endRange</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">lookupCoordinate</span> <span class="ow">and</span> <span class="p">(</span><span class="n">strand</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="n">strand</span><span class="p">))]</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">optim</span> <span class="o">==</span> <span class="s1">&#39;nb&#39;</span><span class="p">:</span>
	    <span class="c1"># Be smarter: take only segments where the end coordinate is bigger than the lookupCoordinate</span>
            <span class="n">ml</span> <span class="o">=</span> <span class="n">lookupCoordinate</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxFeatureSizes</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]</span> <span class="c1"># We start looking from the most left index possible given our knowledge of the longest feature:</span>
            <span class="n">startRange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span><span class="p">[</span><span class="n">chromosome</span><span class="p">],</span> <span class="n">ml</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span> <span class="c1"># Find where the left most index lies</span>
            <span class="c1"># For more optimalisation we want to skip the searchsorted and prefetch the lookup array?</span>

            <span class="n">endRange</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]))</span> <span class="c1"># We stop looking at the leftmost h</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Start looking from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">startRange</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;To </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">endRange</span><span class="p">)</span>
                <span class="c1">#self.debugMsg(&quot;start is %s&quot;%self.startIndexLookup[chromosome][k])</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startRange</span><span class="p">,</span><span class="n">endRange</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">lookupCoordinate</span> <span class="p">)</span>

        <span class="k">elif</span> <span class="n">optim</span> <span class="o">==</span> <span class="s1">&#39;optim&#39;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span><span class="p">[</span><span class="n">chromosome</span><span class="p">],</span> <span class="n">lookupCoordinate</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            <span class="c1"># Be smarter: take only segments where the end coordinate is bigger than the lookupCoordinate</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">])))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">lookupCoordinate</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endCoordinates</span><span class="p">[</span><span class="n">chromosome</span><span class="p">],</span> <span class="n">lookupCoordinate</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
            <span class="n">leftSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">])))</span> <span class="p">)</span>
            <span class="n">rightSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">endIndexLookup</span><span class="p">[</span><span class="n">chromosome</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">])),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">chromosome</span><span class="p">]))</span> <span class="p">)</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="n">leftSet</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span> <span class="n">rightSet</span> <span class="p">)</span>
        <span class="k">return</span><span class="p">(</span> <span class="p">[</span><span class="n">candidate</span> <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="p">(</span><span class="n">strand</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">candidate</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="n">strand</span> <span class="p">)]</span> <span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if self.debug:</span>
<span class="sd">            self.debugMsg(&quot;Looking up %s %s %s Hit %s %s&quot; % (chromosome, lookupCoordinate, strand, s, e))</span>
<span class="sd">            self.debugMsg(self.startCoordinates[chromosome])</span>
<span class="sd">        hits = []</span>
<span class="sd">        for i in range(s, self.endIndexLookup[chromosome][e] ): #min(s+1, len(self.features[chromosome]))</span>
<span class="sd">            if self.features[chromosome][i][0]&lt;=lookupCoordinate and self.features[chromosome][i][1]&gt;=lookupCoordinate:</span>
<span class="sd">                if self.debug:</span>
<span class="sd">                    self.debugMsg(&quot;  Strandless Hit feature %s %s %s [%s %s]&quot; % (self.features[chromosome][i][0], self.features[chromosome][i][1], self.features[chromosome][i][2], self.features[chromosome][i][3],  self.features[chromosome][i][4]))</span>
<span class="sd">                if strand is None or strand==self.features[chromosome][i][3]:</span>
<span class="sd">                    hits.append(self.features[chromosome][i])</span>
<span class="sd">                elif self.debug:</span>
<span class="sd">                    self.debugMsg(&quot;   Strand miss %s for %s %s&quot; % (strand, i, self.features[chromosome][i][3] ))</span>
<span class="sd">            elif self.debug:</span>
<span class="sd">                self.debugMsg(&quot;  Missed feature %s %s %s [%s %s]&quot; % (self.features[chromosome][i][0], self.features[chromosome][i][1], self.features[chromosome][i][2], self.features[chromosome][i][3],  self.features[chromosome][i][4]))</span>
<span class="sd">                self.debugMsg(&quot;    reason:&quot;  &quot;%s &lt;= coord&quot; % self.features[chromosome][i][0] if  self.features[chromosome][i][0]&lt;=lookupCoordinate else &quot;%s &gt; coord&quot; % self.features[chromosome][i][1] )</span>
<span class="sd">        return(hits)</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="FeatureContainer.findFeaturesAtPysamAlign"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.findFeaturesAtPysamAlign">[docs]</a>    <span class="k">def</span> <span class="nf">findFeaturesAtPysamAlign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pysamRead</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obtain all features mapping the pysam aligned segment.</span>
<span class="sd">        method 0: Query EVERY base</span>
<span class="sd">        method 1: Query every subsequent block of reads (pysam aligned segment .get_blocks)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pysamRead</span><span class="o">.</span><span class="n">reference_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Chromosome </span><span class="si">%s</span><span class="s2"> is not present in the annotations&quot;</span> <span class="o">%</span> <span class="n">pysamRead</span><span class="o">.</span><span class="n">reference_name</span><span class="p">)</span>
            <span class="k">return</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">hits</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">queryPos</span><span class="p">,</span> <span class="n">referencePos</span> <span class="ow">in</span> <span class="n">pysamRead</span><span class="o">.</span><span class="n">get_aligned_pairs</span><span class="p">(</span><span class="n">matches_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_seq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                 <span class="n">hits</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span> <span class="n">pysamRead</span><span class="o">.</span><span class="n">reference_name</span><span class="p">,</span> <span class="n">referencePos</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="n">strand</span><span class="p">)</span> <span class="p">))</span>
            <span class="k">return</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">findFeaturesBetween</span><span class="p">(</span>
                                         <span class="n">pysamRead</span><span class="o">.</span><span class="n">reference_name</span><span class="p">,</span>
                                         <span class="n">lookupCoordinateStart</span><span class="p">,</span>
                                         <span class="n">lookupCoordinateEnd</span><span class="p">,</span>
                                         <span class="n">strand</span><span class="o">=</span><span class="n">strand</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">lookupCoordinateStart</span><span class="p">,</span><span class="n">lookupCoordinateEnd</span>
                    <span class="ow">in</span> <span class="n">pysamRead</span><span class="o">.</span><span class="n">get_blocks</span><span class="p">()</span> <span class="p">])))</span></div>

<div class="viewcode-block" id="FeatureContainer.findFeaturesBetweenBRK"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.findFeaturesBetweenBRK">[docs]</a>    <span class="k">def</span> <span class="nf">findFeaturesBetweenBRK</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chromosome</span><span class="p">,</span> <span class="n">lookupCoordinateStart</span><span class="p">,</span> <span class="n">lookupCoordinateEnd</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Obtain all features between Start and end coordinate.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chromosome</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">startCoordinates</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Chromosome </span><span class="si">%s</span><span class="s2"> is not present in the annotations&quot;</span> <span class="o">%</span> <span class="n">chromosome</span><span class="p">)</span>
            <span class="k">return</span><span class="p">([])</span>

        <span class="sd">&quot;&quot;&quot;Find all features which are present at both the supplied start and end coordinate&quot;&quot;&quot;</span>
        <span class="n">startHits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="n">chromosome</span><span class="p">,</span> <span class="n">lookupCoordinateStart</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
        <span class="n">endHits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="n">chromosome</span><span class="p">,</span> <span class="n">lookupCoordinateEnd</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;Hits at </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">chromosome</span><span class="p">,</span> <span class="n">lookupCoordinateEnd</span><span class="p">,</span> <span class="n">strand</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">startHits</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugMsg</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">endHits</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">startHits</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span> <span class="nb">set</span><span class="p">(</span><span class="n">endHits</span><span class="p">))</span> <span class="p">))</span></div>


<div class="viewcode-block" id="FeatureContainer.loadSNPSFromVcf"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.loadSNPSFromVcf">[docs]</a>    <span class="k">def</span> <span class="nf">loadSNPSFromVcf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vcfFilePath</span><span class="p">,</span> <span class="n">locations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">pysam</span><span class="o">.</span><span class="n">VariantFile</span><span class="p">(</span><span class="n">vcfFilePath</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">locations</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">chrom</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">samples</span><span class="p">:</span>
                    <span class="c1"># get genotypes:</span>
                    <span class="k">for</span> <span class="n">allele</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">samples</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span><span class="o">.</span><span class="n">alleles</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">addVariant</span><span class="p">(</span><span class="n">chromosome</span><span class="o">=</span><span class="n">rec</span><span class="o">.</span><span class="n">chrom</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">allele</span><span class="p">,</span>  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SNP&#39;</span><span class="p">,</span><span class="n">variantType</span><span class="o">=</span><span class="s1">&#39;SNP&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span></div>
<div class="viewcode-block" id="FeatureContainer.addVariant"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.FeatureContainer.addVariant">[docs]</a>    <span class="k">def</span> <span class="nf">addVariant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chromosome</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SNP&#39;</span><span class="p">,</span><span class="n">variantType</span><span class="o">=</span><span class="s1">&#39;SNP&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">end</span> <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">start</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;G&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not a base&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">chromosome</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;SNP&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="massIdConvert"><a class="viewcode-back" href="../../../source/singlecellmultiomics.features.html#singlecellmultiomics.features.features.massIdConvert">[docs]</a><span class="k">def</span> <span class="nf">massIdConvert</span><span class="p">(</span><span class="n">baseIds</span><span class="p">,</span> <span class="n">pathToIdMapping</span><span class="o">=</span><span class="s1">&#39;/media/sf_data/references/human/HUMAN_9606_idmapping_selected.tab.gz&#39;</span><span class="p">,</span> <span class="n">targetCol</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert GENE identifiers into another format.</span>
<span class="sd">    Get a conversion table from ftp://ftp.uniprot.org/pub/databases/uniprot/current_release/knowledgebase/idmapping/by_organism/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">converted</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">baseIds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">baseIds</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pathToIdMapping</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">h</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">baseIds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">convertedTo</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="n">targetCol</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">convertedTo</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">converted</span><span class="p">:</span>
                        <span class="n">converted</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">converted</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convertedTo</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">converted</span><span class="p">)</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;The following are all test functions for the annotation class&quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">colorama</span> <span class="k">import</span> <span class="n">Fore</span> <span class="c1">#,Back, Style</span>
    <span class="kn">from</span> <span class="nn">colorama</span> <span class="k">import</span> <span class="n">Back</span>
    <span class="kn">from</span> <span class="nn">colorama</span> <span class="k">import</span> <span class="n">Style</span>
    <span class="kn">from</span> <span class="nn">colorama</span> <span class="k">import</span> <span class="n">init</span>
    <span class="n">init</span><span class="p">(</span><span class="n">autoreset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">formatColor</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[GREEN]&quot;</span><span class="p">,</span> <span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[RED]&quot;</span><span class="p">,</span> <span class="n">Fore</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[DIM]&quot;</span><span class="p">,</span> <span class="n">Style</span><span class="o">.</span><span class="n">DIM</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[RESET]&quot;</span><span class="p">,</span> <span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]&quot;</span><span class="p">,</span> <span class="n">Style</span><span class="o">.</span><span class="n">BRIGHT</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[NORMAL]&quot;</span><span class="p">,</span> <span class="n">Style</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">printFormatted</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">formatColor</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">string</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">printFormattedDim</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">formatColor</span><span class="p">(</span><span class="s2">&quot;   [DIM]</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">string</span><span class="p">)))</span>
    <span class="sd">&quot;&quot;&quot;Self tests:&quot;&quot;&quot;</span>

    <span class="c1"># addFeature( chromosome, start, end, name, strand=None, data=None):</span>
    <span class="c1"># Build the reference:</span>
    <span class="nb">print</span><span class="p">(</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    .......(1)----------------------&gt;</span>
<span class="sd">    ..............&lt;----------------(2)</span>
<span class="sd">    chr1   100    110             200</span>


<span class="sd">    .......(3)----------------------&gt;</span>
<span class="sd">    .......(4)-----&gt;</span>
<span class="sd">    .......(5)&lt;-------------</span>
<span class="sd">    chr2   100    110     150     200</span>
<span class="sd">    .</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">desired</span><span class="p">,</span> <span class="n">presenceTestOnly</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">presenceTestOnly</span><span class="p">:</span>
            <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;Expecting </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">desired</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;[BRIGHT][GREEN] SUCCES [RESET][DIM]</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">desired</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;[RED]FAIL </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">result</span> <span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">desired</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;Expecting </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">desired</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;[BRIGHT][GREEN] SUCCES [RESET][DIM]</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;[RED]FAIL </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">result</span> <span class="p">))</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">desired</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;Expecting </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">desired</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;[BRIGHT][GREEN] SUCCES [RESET][DIM]</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">desired</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">desired</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;[RED]FAIL </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">result</span> <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;Expecting </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">desired</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;[BRIGHT][GREEN] SUCCES [RESET][DIM]</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="n">desired</span> <span class="k">else</span> <span class="s1">&#39;[RED]FAIL </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">result</span> <span class="p">))</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">FeatureContainer</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">f</span><span class="o">.</span><span class="n">debugMsg</span> <span class="o">=</span> <span class="n">printFormattedDim</span>
    <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chrY&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chrY&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrY&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrY&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrY&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrY&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrY&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrY&#39;</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrY&#39;</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrY&#39;</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>


    <span class="n">f</span> <span class="o">=</span> <span class="n">FeatureContainer</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">f</span><span class="o">.</span><span class="n">debugMsg</span> <span class="o">=</span> <span class="n">printFormattedDim</span>
    <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chrX&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;parentB&#39;</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chrX&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="s1">&#39;nestedB&#39;</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chrX&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chrX&#39;</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mi">120000</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrX&#39;</span><span class="p">,</span><span class="mi">550</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrX&#39;</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrX&#39;</span><span class="p">,</span><span class="mi">100000000</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrX&#39;</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrX&#39;</span><span class="p">,</span><span class="mi">12001</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrX&#39;</span><span class="p">,</span><span class="mi">12000</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrX&#39;</span><span class="p">,</span><span class="mi">120000</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chrX&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="s1">&#39;parentB&#39;</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">FeatureContainer</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">f</span><span class="o">.</span><span class="n">debugMsg</span> <span class="o">=</span> <span class="n">printFormattedDim</span>

    <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chr1&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span>  <span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;A forward feature from 100 to 200 chr1&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chr1&#39;</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>  <span class="s1">&#39;A reverse feature from 110 to 200 chr1&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chr2&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span>  <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;A forward feature from 100 to 200 chr2&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chr2&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span>  <span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;A forward feature from 100 to 110 chr2&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chr2&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span>  <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;A reverse feature from 100 to 150 chr2&#39;</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chr3&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span>  <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;feature 6&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chr3&#39;</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span>  <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;feature 7&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chr3&#39;</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span>  <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;feature 8&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chr3&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;feature 9&#39;</span><span class="p">)</span>



    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test for reference presence:&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">getReferenceList</span><span class="p">()</span>
    <span class="n">desired</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chr1&#39;</span><span class="p">,</span><span class="s1">&#39;chr2&#39;</span><span class="p">,</span><span class="s1">&#39;chr3&#39;</span><span class="p">]</span>
    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;Expecting </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">desired</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;[BRIGHT][GREEN] SUCCES [RESET][DIM]</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">desired</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">desired</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;[RED]FAIL </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">result</span> <span class="p">))</span>

    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test on leftmost start:&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chr1&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>

    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test on rightmost end:&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chr1&#39;</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>

    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test on random location within feature:&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span>  <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chr1&#39;</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>

    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test on random location within feature:&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chr2&#39;</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="s1">&#39;3&#39;</span><span class="p">)</span>

    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test on limit location of feature:&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chr2&#39;</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="s1">&#39;3&#39;</span><span class="p">)</span>

    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test on non matching location (match available on other side, and one base left of coord):&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chr2&#39;</span><span class="p">,</span><span class="mi">151</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Tests on double matching locations without strand spec&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chr1&#39;</span><span class="p">,</span><span class="mi">120</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">])</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chr2&#39;</span><span class="p">,</span><span class="mi">105</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">])</span>


    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT] ==== Range tests... ====&quot;</span> <span class="p">)</span>
    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test for matching start and end coordinates overlapping one feature&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span>  <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesBetween</span><span class="p">(</span><span class="s1">&#39;chr2&#39;</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span> <span class="p">),</span> <span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">])</span>

    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test for matching all features on chromosome&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span>  <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesBetween</span><span class="p">(</span><span class="s1">&#39;chr2&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20000</span><span class="p">,</span> <span class="kc">None</span> <span class="p">),</span> <span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">])</span>

    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test for matching all but one features on chromosome&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span>  <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesBetween</span><span class="p">(</span><span class="s1">&#39;chr3&#39;</span><span class="p">,</span><span class="mi">151</span><span class="p">,</span> <span class="mi">20000</span><span class="p">,</span> <span class="kc">None</span> <span class="p">),</span> <span class="p">[</span><span class="s1">&#39;8&#39;</span><span class="p">,</span><span class="s1">&#39;7&#39;</span><span class="p">])</span>

    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test for matching all but one features on chromosome&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span>  <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesBetween</span><span class="p">(</span><span class="s1">&#39;chr3&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="kc">None</span> <span class="p">),</span> <span class="p">[</span><span class="s1">&#39;6&#39;</span><span class="p">,</span><span class="s1">&#39;9&#39;</span><span class="p">])</span>

    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test for range finding non-existent feature&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span>  <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesBetween</span><span class="p">(</span><span class="s1">&#39;chr2&#39;</span><span class="p">,</span> <span class="mi">2001</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span> <span class="p">),</span> <span class="kc">None</span><span class="p">)</span>


    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test for finding non-existent feature LEFT NEXT to the point&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span>  <span class="n">f</span><span class="o">.</span><span class="n">findNearestLeftFeature</span><span class="p">(</span><span class="s1">&#39;chr2&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span> <span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test for finding existent feature LEFT NEXT to the point&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span>  <span class="n">f</span><span class="o">.</span><span class="n">findNearestLeftFeature</span><span class="p">(</span><span class="s1">&#39;chr2&#39;</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="kc">None</span> <span class="p">),</span> <span class="s1">&#39;3&#39;</span><span class="p">)</span>


    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test for finding non-existent feature RIGHT NEXT to the point&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span>  <span class="n">f</span><span class="o">.</span><span class="n">findNearestRightFeature</span><span class="p">(</span><span class="s1">&#39;chr2&#39;</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span> <span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test for finding existent feature RIGHT NEXT to the point&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span>  <span class="n">f</span><span class="o">.</span><span class="n">findNearestRightFeature</span><span class="p">(</span><span class="s1">&#39;chr2&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span> <span class="p">),</span> <span class="s1">&#39;5&#39;</span><span class="p">)</span>


    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test for finding closest feature&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findNearestFeature</span><span class="p">(</span><span class="s1">&#39;chr1&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span> <span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span>  <span class="n">f</span><span class="o">.</span><span class="n">findNearestFeature</span><span class="p">(</span><span class="s1">&#39;chr1&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span> <span class="p">),</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>


    <span class="c1">####################################### Sharing related stuff</span>
    <span class="sd">&quot;&quot;&quot;from multiprocessing.managers import BaseManager</span>
<span class="sd">    import multiprocessing</span>
<span class="sd">    # Share the genome annotations over multiple processes:</span>
<span class="sd">    class bdbsSharedObjectManager(BaseManager): pass</span>
<span class="sd">    def Manager():</span>
<span class="sd">        m = bdbsSharedObjectManager()</span>
<span class="sd">        m.start()</span>
<span class="sd">        return m</span>
<span class="sd">    # initialisation #</span>
<span class="sd">    bdbsSharedObjectManager.register(&#39;FeatureContainer&#39;, FeatureContainer)</span>
<span class="sd">    sharedDataManager = Manager()</span>
<span class="sd">    f = sharedDataManager.FeatureContainer()</span>


<span class="sd">    def findFeaturesAt(args):</span>
<span class="sd">        featureContainer, chromosome, position, strand = args</span>
<span class="sd">        featureContainer.findFeaturesAt(chromosome, position, strand )</span>

<span class="sd">    print(&#39;Running with pool&#39;)</span>
<span class="sd">    pool = multiprocessing.Pool(8)</span>
<span class="sd">    print(&quot;With index:&quot;)</span>
<span class="sd">    bar = progressbar.ProgressBar(max_value=N)</span>
<span class="sd">    for q,result in enumerate(pool.imap( findFeaturesAt, (  (f, &#39;chr1&#39;, q, &#39;+&#39;) for q in range(N) ),1000)):</span>
<span class="sd">         bar.update(q)</span>
<span class="sd">        #expect( f.findFeaturesAt(&#39;chr1&#39;,q,&#39;+&#39;), &#39;1&#39;, True)</span>
<span class="sd">    bar.finish()</span>
<span class="sd">    exit()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#######################################</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="kn">import</span> <span class="nn">progressbar</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating random features&#39;</span><span class="p">)</span>

    <span class="n">N</span> <span class="o">=</span> <span class="mi">1000000</span>
    <span class="n">f</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">printFormatted</span><span class="p">(</span><span class="s2">&quot;[BRIGHT]Test with </span><span class="si">%s</span><span class="s2"> random features added to the chromosome&quot;</span> <span class="o">%</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chr1&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="n">_000_000</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="s1">&#39;chr1&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="p">),</span><span class="s1">&#39;art_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">][</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)],</span>  <span class="s1">&#39;A random feature&#39;</span><span class="p">)</span>
        <span class="c1">#f.findNearestFeature(&#39;chr1&#39;, random.randint(0,1000), &#39;+&#39;)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Constructing index...&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="c1">#######################################</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;With index:&quot;</span><span class="p">)</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">max_value</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
         <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chr1&#39;</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
         <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="c1">#expect( f.findFeaturesAt(&#39;chr1&#39;,q,&#39;+&#39;), &#39;1&#39;, True)</span>
    <span class="n">bar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Without index:&quot;</span><span class="p">)</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">max_value</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
         <span class="n">f</span><span class="o">.</span><span class="n">findFeaturesAt</span><span class="p">(</span><span class="s1">&#39;chr1&#39;</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">optim</span><span class="o">=</span><span class="s1">&#39;nb&#39;</span><span class="p">)</span>
         <span class="n">bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="c1">#expect( f.findFeaturesAt(&#39;chr1&#39;,q,&#39;+&#39;), &#39;1&#39;, True)</span>
    <span class="n">bar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Buys de Barbanson, Jake Yeung.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>